name: Build UDisk Tool

# 手动触发运行
on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（如 v1.0.0）'
        required: true
        default: 'v1.0.0'

# 移除Release相关权限，仅保留必要的读取权限
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [windows, linux]
        goarch: [amd64] # 仅amd64架构
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Go环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: false # 先禁用自动缓存

      - name: 初始化go mod（指定模块名）
        run: go mod init udisk-write-verify

      - name: 整理依赖并生成go.sum
        run: go mod tidy

      - name: 启用Go模块缓存（生成go.sum后）
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: 验证依赖
        run: go mod verify

      - name: 编译前清理旧产物
        run: |
          # 删除所有旧的二进制和校验文件，避免文件冲突
          rm -rf udisk-write-verify_* *.exe *.sha256 ./build
          # 创建唯一的输出目录，确保路径不冲突
          mkdir -p ./build/${{ matrix.goos }}/${{ matrix.goarch }}

      - name: 编译二进制文件
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0 # 禁用CGO，生成静态二进制
        run: |
          # 定义唯一的输出文件名（带系统/架构标识）
          if [ "${{ matrix.goos }}" = "windows" ]; then
            output_name="udisk-write-verify_${{ matrix.goos }}_${{ matrix.goarch }}.exe"
          else
            output_name="udisk-write-verify_${{ matrix.goos }}_${{ matrix.goarch }}"
          fi
          # 输出到唯一目录，避免矩阵编译冲突
          output_path="./build/${{ matrix.goos }}/${{ matrix.goarch }}/$output_name"
          
          # 编译（强制覆盖已有文件）
          go build -ldflags "-s -w" -o "$output_path" main.go
          
          # 生成校验和（输出到同一目录）
          sha256sum "$output_path" > "$output_path.sha256"
          
          # 验证文件是否生成
          if [ ! -f "$output_path" ]; then
            echo "编译失败：文件 $output_path 不存在"
            exit 1
          fi

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          # 产物名称包含版本、系统、架构，方便识别
          name: udisk-tools-${{ github.event.inputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            ./build/${{ matrix.goos }}/${{ matrix.goarch }}/*
          # 保留90天，可根据需求调整
          retention-days: 90
