on:
  workflow_dispatch:
    inputs:
      build_target:
        description: '选择要编译的平台'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - windows
          - linux

name: 手动编译 Windows & Linux 二进制

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: false

      - name: Init Go modules and install dependencies
        run: |
          if [ ! -f go.mod ]; then
            go mod init udisk-tool
          fi
          # 下载 Blake2b 依赖
          go get golang.org/x/crypto/blake2b
          go mod tidy

      - name: Build Linux binary
        if: ${{ github.event.inputs.build_target == 'linux' || github.event.inputs.build_target == 'both' }}
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o app-linux main.go udisk_linux.go
          chmod +x app-linux
          ls -lh app-linux

      - name: Build Windows binary
        if: ${{ github.event.inputs.build_target == 'windows' || github.event.inputs.build_target == 'both' }}
        run: |
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o app-windows.exe main.go udisk_windows.go
          ls -lh app-windows.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ github.event.inputs.build_target }}
          path: |
            app-linux*
            app-windows.exe*
          retention-days: 7
