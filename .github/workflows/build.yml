name: Build Windows Binary & Release

# 触发条件：手动触发、推送到main分支、创建Tag时触发
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]  # 匹配v1.0.0等Tag
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest  # Linux编译环境
    steps:
      # 1. 检出代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 配置Go 1.26环境
      - name: Set Up Go 1.26
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: true  # 启用模块缓存，加速编译

      # 3. 交叉编译Windows二进制
      - name: Cross Compile for Windows
        run: |
          # 设置交叉编译环境变量
          export GOOS=windows
          export GOARCH=amd64
          export CGO_ENABLED=0  # 禁用CGO，生成静态二进制
          
          # 编译并优化体积
          go build -ldflags="-s -w" -o usb-sha1-test.exe main.go
          
          # 验证编译结果
          ls -la usb-sha1-test.exe
          file usb-sha1-test.exe

      # 4. 生成校验和（可选，用于文件完整性验证）
      - name: Generate SHA256 Checksum
        run: |
          sha256sum usb-sha1-test.exe > usb-sha1-test.sha256
          cat usb-sha1-test.sha256

      # 5. 发布到GitHub Release（仅创建Tag时）
      - name: Publish to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            usb-sha1-test.exe
            usb-sha1-test.sha256
          generate_release_notes: true  # 自动生成发布说明
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub内置Token

      # 6. 上传构建产物（所有触发方式都能下载）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: usb-sha1-test-windows-amd64
          path: |
            usb-sha1-test.exe
            usb-sha1-test.sha256
