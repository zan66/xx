name: Build UDisk Tool

# 手动触发运行
on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（如 v1.0.0）'
        required: true
        default: 'v1.0.0'

# 仅保留读取权限
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [windows, linux]
        goarch: [amd64]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Go环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: false # 禁用自动缓存，手动控制

      - name: 清理旧依赖和缓存冲突文件
        run: |
          # 删除可能导致缓存冲突的依赖文件
          rm -rf ~/go/pkg/mod/golang.org/x/crypto*
          rm -rf ~/.cache/go-build/*
          # 删除项目内的mod缓存
          rm -rf go.mod go.sum

      - name: 启用Go模块缓存（优先恢复缓存，再执行mod操作）
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
        # 允许缓存恢复失败（不阻断流程）
        continue-on-error: true

      - name: 初始化go mod
        run: go mod init udisk-write-verify

      - name: 整理依赖（缓存缺失时重新生成）
        run: go mod tidy -compat=1.26

      - name: 验证依赖
        run: go mod verify

      - name: 编译前清理旧产物
        run: |
          rm -rf udisk-write-verify_* *.exe *.sha256 ./build
          mkdir -p ./build/${{ matrix.goos }}/${{ matrix.goarch }}

      - name: 编译二进制文件
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            output_name="udisk-write-verify_${{ matrix.goos }}_${{ matrix.goarch }}.exe"
          else
            output_name="udisk-write-verify_${{ matrix.goos }}_${{ matrix.goarch }}"
          fi
          output_path="./build/${{ matrix.goos }}/${{ matrix.goarch }}/$output_name"
          
          go build -ldflags "-s -w" -o "$output_path" main.go
          sha256sum "$output_path" > "$output_path.sha256"
          
          if [ ! -f "$output_path" ]; then
            echo "编译失败：文件 $output_path 不存在"
            exit 1
          fi

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: udisk-tools-${{ github.event.inputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            ./build/${{ matrix.goos }}/${{ matrix.goarch }}/*
          retention-days: 90
