# 触发条件：push/PR 到 main 分支时触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 工作流名称
name: Build Windows & Linux Binaries

# 任务配置
jobs:
  build:
    # 运行环境：Ubuntu 最新版（Linux 编译跨平台更方便）
    runs-on: ubuntu-latest
    
    steps:
      # 1. 拉取代码到构建环境
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 配置 Go 环境（适配你的 Go 版本，建议指定具体版本如 1.22）
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: true # 缓存依赖，加速构建

      # 3. 初始化 Go 模块（解决你之前的 syscall.NewLazyDLL 编译问题）
      - name: Init Go modules
        run: |
          go mod init your-app-name || true # 已有 mod 则忽略错误
          go mod tidy

      # 4. 编译 Linux 二进制文件（amd64 架构）
      - name: Build Linux binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o app-linux main.go
          # 验证二进制文件（可选）
          chmod +x app-linux
          ls -lh app-linux

      # 5. 编译 Windows 二进制文件（amd64 架构，exe 格式）
      - name: Build Windows binary
        run: |
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o app-windows.exe main.go
          ls -lh app-windows.exe

      # 6. （可选）上传编译产物，方便下载
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: |
            app-linux
            app-windows.exe
          retention-days: 7 # 产物保留 7 天
